# 1ZJXL数据接口

- 数据智能事业部SaaS平台：http://192.168.1.20/datagroup/saas
- SaaS系统架构
- Api服务监控
- SaaS数据平台
- 中交兴路软件接口文档设计
- 中交兴路与北理工技术合作方案20220510



## 1.1SaaS系统架构&数据平台





![](https://java-notes-1308812086.cos.ap-beijing.myqcloud.com/image-20220802160657218.png)





![](https://java-notes-1308812086.cos.ap-beijing.myqcloud.com/image-20220802160811593.png)





![](https://java-notes-1308812086.cos.ap-beijing.myqcloud.com/image-20220802161235629.png)

### Saas数据平台构成

- Saas数据平台后台
  - 负责产品运营管理。
  - 负责前台租户的权限配置，资源管理，以及静态资源配置等。
  - 负责API 服务的配置管理，包括访问频次控制，过期配置,  IP白名单配置等。

- Saas数据平台前台
  - 前台也即saas平台客户使用界面。	
  - 管理中心包括当前租户下用户的管理，资源管理，权限管理等基本的管理服务。	
  - 数据中心包括数据集，数据源，仪表盘，报表等功能，目前平台下支持3中模式的报表创建模式，多维分析报表，配置报表（基于脚本），快速配置报表（基于拖拽方式）。可以支持包括JDBC，文件，文档等多种常用的数据源。能够为客户数据分析和展现提供丰富的数据和结构支撑。	
  - 拓展功能包括 车辆画像，车型画像，充电桩相关信息。

- Saas数据平台API模块
  - API服务是基于数据平台鉴权和客户授权管理的服务平台。
  - API服务内容包括：接收客户同步信息，标准化数据，客户定制化数据。不仅可以实现以API的方式提供服务，同时也可以实现数据的定向拉取和实时推送的功能。



### 模块描述

- Web网关：负责平台所有 web 服务的转发和鉴权
- Api网关：负责平台所有以 api 形式访问服务的鉴权
- 授权服务：负责所有用户的鉴权
- Ras（数据分析服务）：通过建模根据不同的指标和维度展示数据结果
- UserCenter（用户中心）：负责用户，租户的管理，用户权限的管理
- Api管理：负责api的管理
- Api监控：负责api访问的监控
- 用户基础服务：负责用户基础信息的维护和管理
- Api服务：对外提供api的服务
- 配置文件管理服务：负责所有服务的配置管理
- 注册与发现服务：负责平台所有服务的注册和发现



### 部署

- K8S
  - saas数据平台是依托于k8s部署和管理的spring clould 微服务项目。
  - 能够很好的实现根据服务资源使用情况动态扩展微服务节点的数据量。提高服务资源的利用率，更好的保证了服务的可扩展性，安全性，稳定性。



![](https://java-notes-1308812086.cos.ap-beijing.myqcloud.com/image-20220802161805150.png)



## 1.2 API服务监控

API请求过程中主要经历的服务（组件）如下：

➭阿里云外网出入口    负责域名DNS解析

➭KeepAlive+LVS负载均衡    负责客户请求的高可用和负载均衡

➭Kubernetes集群    是一种微服务的devOpts方案，提供容器化部署和管理发策略，为微服务的治理提供便利。API服务提供服务的能力是通过Kuberntes集群提供的

➭数据库服务（Mysql、TIDB和Redis等）   负责数据存取

![](https://java-notes-1308812086.cos.ap-beijing.myqcloud.com/image-20220802162049833.png)





监控层面上可以分为两种：

➭硬件监控

➭软件监控

➭第三方服务监控

硬件监控/软件监控

主要监控手段： zabbix/prometheuss + Grafana

zabbix和prometheuss 负责采集服务器/服务的指标信息。

Grafana负责展示采集到的服务器/服务指标信息，通过阈值来触发当指标过限时向管理员发送微信、短信和邮件等形式进行提醒。

第三方服务监控

阿里云外网出口，此服务的监控需要通过阿里云企业客户管理平台来查看，具体细节需要运维提供。



![](https://java-notes-1308812086.cos.ap-beijing.myqcloud.com/image-20220802162256682.png)



上图就是客户请求到API服务的各个环节的流程图，从上图可以看出只有请求到达NGINX之后才会记录日志。

请求动作是客户发起的根据HTTP协议的特点，客户记录的日志数量应大于等于我们记录的日志数量。



## 1.3接口文档



### 1.3.1车辆入网验证（是否入网）veh-subscription-api

验证车辆是否入网北理工，用于客户确认签约。根据车辆的**车牌号、车架号**,判断是否为车联网车辆。

- 入参
  - 车牌号 `vehicleNo`
  - 车架号 `vinCode`
  - 订阅状态 `subFlag`
- 处理逻辑
  - 校验参数
  - 获取存在静态数据的车辆
  - 判断是订阅还是取消订阅
    - `vehicleSubscription(List<String> queryList, List<VehicleStaticThinEntity>existVehicles, boolean vinQueryFlag)`

针对订阅状态处理如下：

- 存在车辆静态数据的车辆
- 新增车辆订阅
  - 只有不存在订阅记录和订阅已经取消的情况下才能插入新的订阅记录
  - 订阅为正在进行中的情况下不用插入记录

- 新增记录
  - 更新数据库
  - 更新Redis

```java
java----
    api----VehicleSubscriptionController（"订阅车辆RTM数据接口"）
    conf----
    constant----
    context----
    error----
    mapper----
    model--------
    service----
    Bootstrap----
resources----
    application.yml----
    
```







### 1.3.2车辆基本信息

查询车辆基本信息，用户需要了解车辆证件真实性及车辆属性等信息。



### 1.3.3车辆最新位置

查询车辆最新位置。发起车辆订阅轨迹后，为保证用户轨迹使用可靠性，会调用最新位置接口多次，最新位置在当前时间 24 小时范围内返回，否则返回空。



### 1.3.4对账（确认支付账单）

确认支付账单



```bash
```



### 1.3.5订阅轨迹

与客户确认签约，发起实时轨迹订阅。



### 1.3.6轨迹推送





### 1.3.7理工新源API 鉴权





## 1.4中交兴路与北理工技术合作方案





![](https://java-notes-1308812086.cos.ap-beijing.myqcloud.com/image-20220802162846910.png)





















