# 

# 概述

XXL-JOB 是一个**轻量级**分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。

从它登记的[接入公司列表](https://www.xuxueli.com/xxl-job/#1.4 发展) ，可以看到拍拍贷、优信二手车、京东、哈啰出行等知名的互联网公司正在使用中。



# 特性

XXL-JOB 提供了 36 点[特性](https://www.xuxueli.com/xxl-job/#1.3 特性)列表，我们将其重新整理如下：

> 归类不一定绝对严谨。在使用中，慢慢感受吧。

## **① 功能强大**

- 1、简单：支持通过 Web 页面对任务进行 CRUD 操作，操作简单，一分钟上手；
- 2、动态：支持动态修改任务状态、启动/停止任务，以及终止运行中任务，即时生效；
- 15、事件触发：除了”Cron 方式”和”任务依赖方式”触发任务执行之外，支持基于事件的触发任务方式。调度中心提供触发任务单次执行的 API 服务，可根据业务事件灵活触发。
- 18、GLUE：提供 Web IDE，支持在线开发任务逻辑代码，动态发布，实时编译生效，省略部署上线的过程。支持 30 个版本的历史版本回溯。 
- 19、脚本任务：支持以 GLUE 模式开发和运行脚本任务，包括 Shell、Python、NodeJS、PHP、PowerShell 等类型脚本;
- 20、命令行任务：原生提供通用命令行任务 Handler（Bean任务，”CommandJobHandler”）；业务方只需要提供命令行即可；
- 21、任务依赖：支持配置子任务依赖，当父任务执行结束且执行成功后将会主动触发一次子任务的执行, 多个子任务用逗号分隔；
- 23、自定义任务参数：支持在线配置调度任务入参，即时生效；
- 25、数据加密：调度中心和执行器之间的通讯进行数据加密，提升调度信息安全性；
- 30、跨平台：原生提供通用 HTTP 任务Handler（Bean 任务，”HttpJobHandler”）；业务方只需要提供 HTTP 链接即可，不限制语言、平台；
- 31、国际化：调度中心支持国际化设置，提供中文、英文两种可选语言，默认为中文；

## **② 高性能**

- 13、分片广播任务：执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发集群中所有执行器执行一次任务，可根据分片参数开发分片任务；
- 14、动态分片：分片广播任务以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。
- 24、调度线程池：调度系统多线程触发调度运行，确保调度精确执行，不被堵塞；
- 29、全异步：任务调度流程全异步化设计实现，如异步调度、异步运行、异步回调等，有效对密集调度进行流量削峰，理论上支持任意时长任务的运行；
- 33、线程池隔离：调度线程池进行隔离拆分，慢任务自动降级进入 ”Slow” 线程池，避免耗尽调度线程，提高系统稳定性；

## **③ 高可用**

- 3、调度中心 HA（中心式）：调度采用中心式设计，“调度中心”自研调度组件并支持集群部署，可保证调度中心 HA；
- 4、执行器 HA（分布式）：任务分布式执行，任务”执行器”支持集群部署，可保证任务执行 HA；
- 7、路由策略：执行器集群部署时提供丰富的路由策略，包括：第一个、最后一个、轮询、随机、一致性 HASH、最不经常使用、最近最久未使用、故障转移、忙碌转移等；
- 8、故障转移：任务路由策略选择”故障转移”情况下，如果执行器集群中某一台机器故障，将会自动 Failover 切换到一台正常的执行器发送调度请求。
- 9、阻塞处理策略：调度过于密集执行器来不及处理时的处理策略，策略包括：单机串行（默认）、丢弃后续调度、覆盖之前调度；
- 10、任务超时控制：支持自定义任务超时时间，任务运行超时将会主动中断任务；
- 11、任务失败重试：支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；其中分片任务支持分片粒度的失败重试；
- 22、一致性：“调度中心”通过 DB 锁保证集群分布式调度的一致性, 一次任务调度只会触发一次执行；

## **④ 监控治理**

- 5、注册中心: 执行器会周期性自动注册任务, 调度中心将会自动发现注册的任务并触发执行。同时，也支持手动录入执行器地址；
- 6、弹性扩容缩容：一旦有新执行器机器上线或者下线，下次调度时将会重新分配任务；
- 12、任务失败告警；默认提供邮件方式失败告警，同时预留扩展接口，可方便的扩展短信、钉钉等告警方式；
- 16、任务进度监控：支持实时监控任务进度；
- 17、Rolling 实时日志：支持在线查看调度结果，并且支持以 Rolling 方式实时查看执行器输出的完整的执行日志；
- 26、邮件报警：任务失败时支持邮件报警，支持配置多邮件地址群发报警邮件；
- 27、推送 Maven 中央仓库: 将会把最新稳定版推送到 Maven 中央仓库, 方便用户接入和使用;
- 28、运行报表：支持实时查看运行数据，如任务数量、调度次数、执行器数量等；以及调度报表，如调度日期分布图，调度成功分布图等；
- 32、容器化：提供官方 Docker 镜像，并实时更新推送 Docker Hub，进一步实现产品开箱即用；
- 34、用户管理：支持在线管理系统用户，存在管理员、普通用户两种角色；
- 35、权限控制：执行器维度进行权限控制，管理员拥有全量权限，普通用户需要分配执行器权限后才允许相关操作；



# 架构设计

## 设计思想

- 将调度行为抽象形成“**调度中心**”公共平台，而平台自身并不承担业务逻辑，“**调度中心**”负责发起调度请求。
- 将任务抽象成分散的 [JobHandler](https://github.com/xuxueli/xxl-job/blob/master/xxl-job-core/src/main/java/com/xxl/job/core/handler/IJobHandler.java) ，交由“**执行器**”统一管理，“**执行器**”负责接收调度请求并执行对应的 JobHandler中 业务逻辑。
  - 因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性。
- 分布式任务调度平台，如果从调度系统的角度来看，可以分成两类
  - 中心化： 调度中心和执行器**分离**，调度中心统一调度，通知某个执行器处理任务。
    - XXL-Job
    - 链家的 [kob](https://github.com/LianjiaTech/kob)
    - 美团的 Crane（暂未开源）
  - 去中心化：调度中心和执行器**一体化**，自己调度自己执行处理任务。
    - [Elastic Job](http://elasticjob.io/docs/elastic-job-lite/00-overview/)
    - 唯品会的 [Saturn](https://github.com/vipshop/Saturn)
    - [Quartz](http://www.quartz-scheduler.org/) 基于数据库的集群方案
    - 淘宝的 [TBSchedule](https://github.com/taobao/TBSchedule)（暂停更新，只能使用阿里云 [SchedulerX](https://cn.aliyun.com/aliware/schedulerx) 服务）

## 系统组成

整个 XXL-JOB 系统，由**调度中心**和**执行器**两个角色组成，分别处于不同的进程中。

### 调度中心

- 负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码。
- 调度系统与任务解耦，提高了系统可用性和稳定性，同时调度系统性能不再受限于任务模块。
- 支持可视化、简单且动态的管理调度信息，包括任务新建，更新，删除， GLUE 开发和任务报警等，所有上述操作都会实时生效。
- 支持监控调度结果以及执行日志，支持执行器 Failover 。

### 执行器

- 负责接收调度请求并执行任务逻辑。任务模块专注于任务的执行等操作，开发和维护更加简单和高效。
- 接收“调度中心”的执行请求、终止请求和日志请求等。

## 架构图

整体架构如下图所示：

![架构图](https://java-notes-1308812086.cos.ap-beijing.myqcloud.com/fe0e3739426128436d7402b028026c4e.jpg)

- 【执行器】：**[注册线程]** 根据配置的【调度中心】的地址，自动注册到【调度中心】。
- 【调度中心】：达到任务触发条件，【调度中心】下发任务给【执行器】。
- 【执行器】：基于 **[任务线程池]** 执行任务，并把执行结果放入 **[内存队列]** 中、把 **[执行日志]** 写入 Log 日志文件中。
- 【执行器】：**[回调线程]** 消费 **[内存队列]** 中的调度结果，主动上报给【调度中心】。
- 当用户在【调度中心】查看 **[Rolling 任务日志]**，【调度中心】请求【执行器】，【执行器】读取 Log 日志文件并返回日志详情。

## 高可用

XXL-JOB 的高可用，需要考虑调度中心的高可用、以及执行器的高可用。

### 调度中心的高可用

1





















# 搭建调度中心









# 搭建执行器





































